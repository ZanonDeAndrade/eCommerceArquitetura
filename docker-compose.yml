services:
  # ===================== BANCOS =====================
  postgres-users:
    image: postgres:15
    container_name: postgres_users
    restart: always
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: 123456
    ports:
      - "5433:5432"
    volumes:
      - postgres_users_data:/var/lib/postgresql/data

  postgres-products:
    image: postgres:15
    container_name: postgres_products
    restart: always
    environment:
      POSTGRES_DB: products_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: 123456
    ports:
      - "5434:5432"
    volumes:
      - postgres_products_data:/var/lib/postgresql/data

  postgres-payments:
    image: postgres:15
    container_name: postgres_payments
    restart: always
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: 123456
    ports:
      - "5435:5432"
    volumes:
      - postgres_payments_data:/var/lib/postgresql/data

  mongo-orders:
    image: mongo:6
    container_name: mongo_orders
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 })' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - "27018:27017"
    volumes:
      - mongo_orders_data:/data/db

  mongo-orders-init:
    image: mongo:6
    container_name: mongo_orders_init
    depends_on:
      mongo-orders:
        condition: service_healthy
    command: ["sh", "-c", "mongosh --host mongo-orders:27017 --eval \"rs.initiate({_id: 'rs0', members: [{ _id: 0, host: 'mongo-orders:27017' }]})\" || true"]
    restart: "no"

  # ===================== SERVIÃ‡OS =====================
  order-service:
    image: ecommercearquitetura/order-service:local
    build: ./order-service
    container_name: orders_service
    restart: always
    environment:
      - PORT=3000
      - DATABASE_URL=mongodb://mongo-orders:27017/orders_db?replicaSet=rs0
      - USERS_SERVICE_URL=http://users-service:3000
      - PRODUCTS_SERVICE_URL=http://products-service:3000
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_PAYMENT_TOPIC=orders.payment.request
      - KAFKA_CLIENT_ID=order-service
    ports:
      - "3009:3000"
    depends_on:
      mongo-orders:
        condition: service_healthy
      mongo-orders-init:
        condition: service_completed_successfully
      kafka:
        condition: service_started
      zookeeper:
        condition: service_started

  users-service:
    image: ecommercearquitetura/users-service:local
    build: ./users-service
    container_name: users_service
    restart: always
    environment:
      - PORT=3000
      - DATABASE_URL=postgresql://user:123456@postgres-users:5432/users_db
    ports:
      - "3002:3000"
    depends_on:
      - postgres-users

  products-service:
    image: ecommercearquitetura/products-service:local
    build: ./products-service
    container_name: products_service
    restart: always
    environment:
      - PORT=3000
      - DATABASE_URL=postgresql://user:123456@postgres-products:5432/products_db
      - EMAIL_SERVICE_URL=http://email-service:3000
      - SUPPLIER_EMAIL=fornecedor@ecommerce.local
      - LOW_STOCK_THRESHOLD=5
    ports:
      - "3003:3000"
    depends_on:
      - postgres-products

  payment-service:
    image: ecommercearquitetura/payment-service:local
    build: ./payment-service
    container_name: payments_service
    restart: always
    environment:
      - PORT=3000
      - DATABASE_URL=postgresql://user:123456@postgres-payments:5432/payments_db
      - ORDER_API_URL=http://order-service:3000
      - EMAIL_SERVICE_URL=http://email-service:3000
      - USERS_SERVICE_URL=http://users-service:3000
      - RABBITMQ_URL=amqp://ecommerce:ecommerce@rabbitmq:5672
      - PAYMENT_NOTIFICATION_QUEUE=payment_notifications
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_PAYMENT_TOPIC=orders.payment.request
      - KAFKA_GROUP_ID=payment-service
      - KAFKA_CLIENT_ID=payment-service
    ports:
      - "3004:3000"
    depends_on:
      - postgres-payments
      - order-service
      - email-service
      - rabbitmq
      - kafka
      - zookeeper

  email-service:
    image: ecommercearquitetura/email-service:local
    build: ./email-service
    container_name: email_service
    restart: always
    environment:
      - PORT=3000
      - MAIL_FROM=no-reply@ecommerce.local
      - LOW_STOCK_THRESHOLD=5
      - RABBITMQ_URL=amqp://ecommerce:ecommerce@rabbitmq:5672
      - PAYMENT_NOTIFICATION_QUEUE=payment_notifications
    ports:
      - "3005:3000"

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=ecommerce
      - RABBITMQ_DEFAULT_PASS=ecommerce
    ports:
      - "5672:5672"
      - "15672:15672"

  # ===================== Kafka =====================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_log:/var/lib/zookeeper/log

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: 168
    volumes:
      - kafka_data:/var/lib/kafka/data

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka_ui
    restart: always
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:29092
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
    depends_on:
      - kafka
      - zookeeper

  # ===================== UIs =====================
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin_container
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres-users
      - postgres-products
      - postgres-payments

  mongo-express:
    image: mongo-express
    container_name: mongo_express_ui
    restart: always
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo-orders
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    ports:
      - "8085:8081"
    depends_on:
      - mongo-orders

  # ===================== Observability =====================
  influxdb:
    image: influxdb:1.8
    container_name: influxdb
    restart: always
    environment:
      - INFLUXDB_DB=k6-payments          # nome do banco ajustado
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3006:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - influxdb

  k6:
    image: grafana/k6:latest
    container_name: k6
    restart: "no"
    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6-payments
    volumes:
      - ./k6-scripts:/scripts
    depends_on:
      - influxdb
    networks:
      - default



# ===================== VOLUMES =====================
volumes:
  postgres_users_data:
  postgres_products_data:
  postgres_payments_data:
  mongo_orders_data:
  pgadmin_data:
  influxdb_data:
  grafana_data:
  kafka_data:
  zookeeper_data:
  zookeeper_log:
